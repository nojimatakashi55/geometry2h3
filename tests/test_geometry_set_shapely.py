# tests/test_geometry_set_shapely.py
import pytest
from shapely.geometry import Point, LineString, LinearRing, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeometryCollection
from geometry2h3.geometry import Geometry

point = Point(138.3129466385537, 36.69884457953947)
linestring1 = LineString([
    (139.766084, 35.681382),
    (139.777254, 35.713768),
    (139.623999, 35.906295),
    (139.80685, 36.3142),
    (139.898283, 36.558701),
    (140.020514, 36.931772),
    (140.18441, 37.094537),
    (140.388412, 37.397983),
    (140.458533, 37.75442),
    (140.633035, 37.995485),
    (140.882049, 38.260297),
    (140.967832, 38.57092),
    (141.071785, 38.74893),
    (141.137586, 38.926283),
    (141.188803, 39.145194),
    (141.122598, 39.282229),
    (141.173715, 39.406453),
    (141.136369, 39.701683),
    (141.217655, 39.960853),
    (141.297394, 40.209936),
    (141.431468, 40.509161),
    (141.153948, 40.719917),
    (140.693449, 40.82749),
    (140.5155834, 41.1450992),
    (140.334926, 41.60107),
    (140.646525, 41.9054),
])
linestring2 = LineString([
    (139.623999, 35.906295),
    (139.389942, 36.139702),
    (139.179739, 36.218575),
    (139.013057, 36.322356),
    (138.977579, 36.693128),
    (138.809891, 36.93611),
    (138.922703, 37.167591),
    (138.853927, 37.447787),
    (138.93873, 37.647752),
    (139.061883, 37.912027),
])
linestring3 = LineString([
    (139.013057, 36.322356),
    (138.849589, 36.362408),
    (138.635062, 36.34255),
    (138.464339, 36.277898),
    (138.249736, 36.396498),
    (138.188686, 36.643),
    (138.359663, 36.847975),
    (138.249476, 37.081813),
    (137.861327, 37.043647),
    (137.4814155, 36.8742374),
    (137.21319, 36.701226),
    (137.010459, 36.727004),
    (136.647763, 36.578273),
])
linearring = LinearRing([
    (139.728553, 35.6197),
    (139.723444, 35.626446),
    (139.715828, 35.633998),
    (139.710106, 35.64669),
    (139.6993714, 35.6586161),
    (139.702687, 35.670168),
    (139.7020716, 35.68304384),
    (139.6986016, 35.68844644),
    (139.700044, 35.701306),
    (139.703782, 35.712285),
    (139.706587, 35.721204),
    (139.71038, 35.728926),
    (139.729329, 35.73159),
    (139.739345, 35.733492),
    (139.746875, 35.736489),
    (139.76086, 35.738062),
    (139.766787, 35.732135),
    (139.770987, 35.727772),
    (139.778837, 35.720495),
    (139.777254, 35.713768),
    (139.7733663, 35.70796362),
    (139.774219, 35.698683),
    (139.770883, 35.69169),
    (139.766084, 35.681382),
    (139.763328, 35.675069),
    (139.75964, 35.665498),
    (139.756749, 35.655646),
    (139.747575, 35.645736),
    (139.7407, 35.6355),
    (139.74044, 35.630152),
])
polygon1 = Polygon([
    (139.728553, 35.6197),
    (139.723444, 35.626446),
    (139.715828, 35.633998),
    (139.710106, 35.64669),
    (139.6993714, 35.6586161),
    (139.702687, 35.670168),
    (139.7020716, 35.68304384),
    (139.6986016, 35.68844644),
    (139.700044, 35.701306),
    (139.703782, 35.712285),
    (139.706587, 35.721204),
    (139.71038, 35.728926),
    (139.729329, 35.73159),
    (139.739345, 35.733492),
    (139.746875, 35.736489),
    (139.76086, 35.738062),
    (139.766787, 35.732135),
    (139.770987, 35.727772),
    (139.778837, 35.720495),
    (139.777254, 35.713768),
    (139.7733663, 35.70796362),
    (139.774219, 35.698683),
    (139.770883, 35.69169),
    (139.766084, 35.681382),
    (139.763328, 35.675069),
    (139.75964, 35.665498),
    (139.756749, 35.655646),
    (139.747575, 35.645736),
    (139.7407, 35.6355),
    (139.74044, 35.630152),
    (139.728553, 35.6197),
])
polygon2 = Polygon(
    [
        (135.51394, 34.647321),
        (135.500722, 34.650187),
        (135.493042, 34.654178),
        (135.495265, 34.666438),
        (135.479976, 34.665518),
        (135.462608, 34.669165),
        (135.466791, 34.682663),
        (135.474868, 34.688974),
        (135.494977, 34.701909),
        (135.494977, 34.701909),
        (135.512136, 34.704934),
        (135.520324, 34.70492),
        (135.532171, 34.697043),
        (135.534482, 34.68858),
        (135.533846, 34.681101),
        (135.53283, 34.673526),
        (135.529925, 34.665247),
        (135.527889, 34.65855),
        (135.52337, 34.647879),
        (135.51394, 34.647321),
    ],
    [[
        (135.48207498835222, 34.685407567708744),
        (135.4909122264798, 34.690097962056754),
        (135.49408445287045, 34.69249263147169),
        (135.50144949234883, 34.6932584506999),
        (135.50629627480748, 34.692629723093226),
        (135.51057386216462, 34.69111697544301),
        (135.51275290190603, 34.69131079777771),
        (135.50874553858216, 34.692407539999515),
        (135.50482441687262, 34.69392971851826),
        (135.50116202012492, 34.694416620643146),
        (135.49133621800263, 34.69343335903617),
        (135.48748983903636, 34.69171262310632),
        (135.48207498835222, 34.685407567708744),
    ]]
)
multipoint = MultiPoint([
    Point(139.766084, 35.681382),
    Point(139.777254, 35.713768),
    Point(139.623999, 35.906295),
    Point(139.389942, 36.139702),
    Point(139.179739, 36.218575),
    Point(139.013057, 36.322356),
    Point(138.849589, 36.362408),
    Point(138.635062, 36.34255),
    Point(138.464339, 36.277898),
    Point(138.249736, 36.396498),
    Point(138.188686, 36.643),
    Point(138.359663, 36.847975),
    Point(138.249476, 37.081813),
    Point(137.861327, 37.043647),
    Point(137.4814155, 36.8742374),
    Point(137.21319, 36.701226),
    Point(137.010459, 36.727004),
    Point(136.647763, 36.578273),
])
multilinestring = MultiLineString([
    linestring1,
    linestring2,
    linestring3
])
multipolygon = MultiPolygon([
    polygon1,
    polygon2
])
geometrycollection = GeometryCollection([
    point,
    linestring1,
    polygon1
])

def run_set_shapely(geom, geom_type):
    g = Geometry(h3_resolution=7)
    g.set_shapely(geom)
    g.fill_h3()

    assert len(g.geoms) == 1
    assert g.geoms[0].geom_type == geom_type
    assert len(g.h3_set) > 0

def test_set_shapely_point():
    run_set_shapely(point, "Point")

def test_set_shapely_linestring():
    run_set_shapely(linestring1, "LineString")

def test_set_shapely_linering():
    run_set_shapely(linearring, "LinearRing")

def test_set_shapely_polygon():
    run_set_shapely(polygon1, "Polygon")

def test_set_shapely_multipoint():
    run_set_shapely(multipoint, "MultiPoint")

def test_set_shapely_multilinestring():
    run_set_shapely(multilinestring, "MultiLineString")

def test_set_shapely_multipolygon():
    run_set_shapely(multipolygon, "MultiPolygon")

def test_set_shapely_geometrycollection():
    run_set_shapely(geometrycollection, "GeometryCollection")

def test_set_shapely_invalid_type():
    g = Geometry(h3_resolution=7)

    with pytest.raises(ValueError):
        g.set_shapely("not a shapely object")
        g.fill_h3()

def test_set_shapely_append_behavior():
    g = Geometry(h3_resolution=7)
    g.set_shapely(Point(139.7, 35.6))
    g.set_shapely(Point(135.0, 34.0), append=True)
    g.fill_h3()

    assert len(g.geoms) == 2
    assert len(g.h3_set) > 0

def test_set_shapely_invalid_geometry():
    g = Geometry(h3_resolution=7)
    bad_poly = Polygon([(0, 0), (1, 1), (1, 0), (0, 1), (0, 0)])

    with pytest.raises(ValueError):
        g.set_shapely(bad_poly)
        g.fill_h3()

@pytest.mark.parametrize("geom", ["", None])
def test_geometry_set_shapely_input(geom):
    g = Geometry(h3_resolution=7)

    with pytest.raises(ValueError):
        g.set_shapely(geom)
        g.fill_h3()
